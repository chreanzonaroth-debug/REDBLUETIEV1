<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Click Counter - Red / Blue / Tie / ចប់សូ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Khmer OS System', 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            padding: 20px;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeaea;
        }

        h1 {
            color: #2c3e50;
            font-size: 1.6rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        h1 i {
            color: #3498db;
            font-size: 1.4rem;
        }

        /* TITLE DISPLAY CONTAINER */
        .title-display-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 3px solid #5a67d8;
            border-radius: 12px;
            padding: 15px;
            margin: 0 auto;
            max-width: 600px;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .title-display-container:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f6d365 0%, #fda085 100%);
        }

        .title-display-label {
            display: block;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .title-display-label i {
            font-size: 1.3rem;
            color: #f6d365;
        }

        .title-display-input {
            width: 100%;
            padding: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 8px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            text-align: center;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .title-display-input:focus {
            outline: none;
            border-color: #f6d365;
            background: white;
            box-shadow: 0 0 0 3px rgba(246, 211, 101, 0.3);
            transform: translateY(-2px);
        }

        .title-display-input::placeholder {
            color: #94a3b8;
            font-weight: 500;
        }

        .title-display-hint {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .title-display-hint i {
            font-size: 0.9rem;
            color: #f6d365;
        }

        /* Counter Section - WITH 4 BUTTONS NOW */
        .counter-section {
            margin-bottom: 20px;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .buttons button {
            padding: 14px 10px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .buttons button i {
            display: none; /* Hide circle icons */
        }

        .buttons button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        .buttons button:active {
            transform: translateY(-1px);
        }

        .btn-red {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
        }

        .btn-blue {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .btn-tie {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
            color: #2d3436;
        }

        /* NEW BUTTON: ចប់សូ */
        .btn-end-session {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            color: white;
            font-weight: 800;
            position: relative;
            overflow: hidden;
        }

        .btn-end-session:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }

        .btn-end-session:hover:before {
            left: 100%;
        }

        /* Controls - SMALLER BUTTONS */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        .btn-undo {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .btn-export {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
        }

        /* Log Section */
        .log-section {
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .log-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
        }

        /* Log Header */
        .log-header {
            display: grid;
            grid-template-columns: 60px 1fr 100px;
            align-items: center;
            gap: 12px;
            background: #004385;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: bold;
            color: #ffffff;
        }

        .log-header span {
            text-align: center;
            font-size: 0.95rem;
        }

        .log-header span:nth-child(1) {
            text-align: center;
        }

        .log-header span:nth-child(2) {
            text-align: left;
            padding-left: 12px;
        }

        .log-header span:nth-child(3) {
            text-align: right;
            padding-right: 12px;
        }

        /* Log Container */
        .log {
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            margin-bottom: 15px;
        }

        .log-empty {
            text-align: center;
            padding: 30px 15px;
            color: #95a5a6;
            font-size: 0.95rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .log-empty i {
            font-size: 2.5rem;
            color: #bdc3c7;
        }

        /* Entry Styles */
        .entry {
            padding: 8px 0;
            margin: 6px 0;
            border-bottom: 1px solid #eee;
            transition: all 0.3s;
        }

        .entry:last-child {
            border-bottom: none;
        }

        .entry-container {
            display: grid;
            grid-template-columns: 50px 1fr 100px;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        /* NEW: Highlight for end-session entries */
        .entry.end-session {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%);
            border: 2px solid #ffd600;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(255, 214, 0, 0.2);
            animation: pulseHighlight 2s ease-in-out;
        }

        @keyframes pulseHighlight {
            0%, 100% { background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%); }
            50% { background: linear-gradient(135deg, #fff59d 0%, #ffeb3b 100%); }
        }

        .entry.end-session .middle-section {
            border-left-color: #ffd600 !important;
            background: linear-gradient(135deg, #fffde7, #fff9c4) !important;
        }

        .entry.end-session .badge {
            background: linear-gradient(135deg, #ffd600, #ffab00) !important;
            color: #333 !important;
            font-weight: 900;
            font-size: 1rem;
        }

        .entry.end-session .sequence-number {
            background: linear-gradient(135deg, #333, #555) !important;
            color: #ffd600 !important;
            font-weight: 900;
        }

        .entry.end-session .time-display {
            background: linear-gradient(135deg, #333, #555) !important;
            color: #ffd600 !important;
            font-weight: 900;
        }

        /* Sequence Number (LEFT) */
        .sequence-number {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffffff;
            text-align: center;
            font-family: 'Khmer OS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #000000, #000000);
            padding: 8px;
            border-radius: 8px;
            min-width: 50px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Middle Section */
        .middle-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 1px 1px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }

        .entry.red .middle-section {
            border-left-color: #ff7675;
            background: linear-gradient(135deg, #fff5f5, #ffeaea);
        }

        .entry.blue .middle-section {
            border-left-color: #74b9ff;
            background: linear-gradient(135deg, #f0f8ff, #e6f2ff);
        }

        .entry.tie .middle-section {
            border-left-color: #95a5a6;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        /* Badge */
        .badge {
            padding: 6px 15px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 110px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .badge.red {
            background: linear-gradient(135deg, #ff6b6b, #ff4444);
        }

        .badge.blue {
            background: linear-gradient(135deg, #4d96ff, #4444ff);
        }

        .badge.tie {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        /* NEW: Badge for end-session */
        .badge.end-session {
            background: linear-gradient(135deg, #ffd600, #ffab00);
            color: #333;
            font-weight: 900;
            min-width: 130px;
        }

        /* Number Display */
        .num-display {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            min-width: 40px;
            text-align: center;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }

        /* Right Section (Time) */
        .right-section {
            display: flex;
            justify-content: flex-end;
            padding: 8px;
        }

        .time-display {
            font-size: 0.95rem;
            font-weight: bold;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            background: #000000;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        /* Entry Hover Effects */
        .entry:hover .middle-section {
            transform: translateX(3px);
            transition: transform 0.2s;
        }

        .entry:hover .sequence-number {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transition: background 0.2s;
        }

        /* CURRENT STATUS SECTION */
        .current-status-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(116, 185, 255, 0.3);
            margin-top: 10px;
        }

        .current-status-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: center;
            justify-content: center;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(8px);
        }

        .status-text {
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            min-width: 120px;
            display: inline-block;
            text-align: center;
        }

        .current-number {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
            display: inline-block;
        }

        /* Footer */
        footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid #eaeaea;
            color: #7f8c8d;
            margin-top: 20px;
        }

        .keyboard-hint {
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .key {
            display: inline-block;
            background: #2c3e50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
            margin: 0 4px;
            font-size: 0.85rem;
        }

        .copyright {
            font-size: 0.8rem;
            color: #95a5a6;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.4rem;
                flex-direction: column;
                text-align: center;
            }

            .buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .buttons button {
                padding: 12px 8px;
                font-size: 0.95rem;
            }

            .title-display-container {
                padding: 12px;
            }

            .title-display-input {
                padding: 14px;
                font-size: 1.1rem;
            }

            .title-display-label {
                font-size: 1rem;
            }

            .controls {
                flex-direction: column;
                gap: 6px;
            }

            .controls button {
                width: 100%;
                min-width: unset;
                padding: 8px 12px;
            }

            .log-header {
                grid-template-columns: 40px 1fr 80px;
                gap: 10px;
                font-size: 0.85rem;
                padding: 10px 12px;
            }

            .entry-container {
                grid-template-columns: 40px 1fr 80px;
                gap: 10px;
            }

            .sequence-number {
                font-size: 1.6rem;
                min-width: 40px;
                padding: 6px;
            }

            .middle-section {
                flex-direction: column;
                gap: 8px;
                padding: 6px 8px;
            }

            .badge {
                min-width: 90px;
                padding: 5px 12px;
                font-size: 0.8rem;
            }

            .num-display {
                font-size: 1.5rem;
                padding: 5px 10px;
            }

            .time-display {
                font-size: 0.85rem;
                min-width: 70px;
                padding: 5px 8px;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .status-item {
                justify-content: center;
                text-align: center;
                font-size: 0.95rem;
            }

            .status-text {
                font-size: 1rem;
                min-width: 100px;
            }

            .current-number {
                font-size: 1.8rem;
                padding: 6px 12px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.2rem;
            }

            .buttons {
                grid-template-columns: 1fr;
            }

            .title-display-container {
                padding: 10px;
            }

            .title-display-input {
                padding: 12px;
                font-size: 1rem;
            }

            .title-display-label {
                font-size: 0.95rem;
            }

            .log-header {
                grid-template-columns: 35px 1fr 70px;
                gap: 8px;
                font-size: 0.8rem;
                padding: 8px 10px;
            }

            .entry-container {
                grid-template-columns: 35px 1fr 70px;
                gap: 8px;
            }

            .sequence-number {
                font-size: 1.4rem;
                min-width: 35px;
                padding: 5px;
            }

            .badge {
                min-width: 80px;
                padding: 4px 10px;
                font-size: 0.75rem;
            }

            .num-display {
                font-size: 1.4rem;
                padding: 4px 8px;
            }

            .time-display {
                font-size: 0.8rem;
                min-width: 60px;
                padding: 4px 6px;
            }
        }

        /* Active state for buttons */
        .active {
            transform: scale(0.95) !important;
            opacity: 0.9;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-mouse-pointer"></i> Click Counter — ក្រហម / ខៀវ / ស្នើ / ចប់សូ</h1>

        <!-- TITLE DISPLAY TEXTBOX -->
        <div class="title-display-container">
            <label class="title-display-label">
                <i class="fas fa-heading"></i> ចំណងជើងអត្ថបទ / កំណត់ចំណាំ
            </label>
            <input
                    type="text"
                    id="titleInput"
                    class="title-display-input"
                    placeholder="បញ្ចូលចំណងជើង ឬកំណត់ចំណាំនៅទីនេះ..."
                    maxlength="100"
            />
            <div class="title-display-hint">
                <i class="fas fa-info-circle"></i> ចំណងជើងនេះនឹងត្រូវរក្សាទុកជាមួយការចុចក្នុង CSV
            </div>
        </div>
    </header>

    <main>
        <section class="counter-section">
            <div class="buttons">
                <button id="red" class="btn-red">
                    ក្រហម (Red)
                </button>
                <button id="blue" class="btn-blue">
                    ខៀវ (Blue)
                </button>
                <button id="tie" class="btn-tie">
                    ស្នើ (Tie)
                </button>
                <!-- NEW BUTTON: ចប់សូ -->
                <button id="endSession" class="btn-end-session">
                    ចប់សូ
                </button>
            </div>
        </section>

        <section class="controls">
            <button id="undo" class="btn-undo">
                <i class="fas fa-undo"></i> Undo
            </button>
            <button id="clear" class="btn-clear">
                <i class="fas fa-trash"></i> សំអាត
            </button>
            <button id="export" class="btn-export">
                <i class="fas fa-download"></i> CSV
            </button>
        </section>

        <section class="log-section">
            <div class="log-header">
                <span>លេខរៀង</span>
                <span>ព័ណ៌ / លេខ</span>
                <span>ពេលវេលា</span>
            </div>
            <div class="log" id="log">
                <div class="log-empty">
                    <i class="fas fa-inbox"></i> មិនមានការចុចទេ។ ចាប់ផ្តើមចុចព័ណ៌ខាងលើ!
                </div>
            </div>

            <!-- CURRENT STATUS SECTION -->
            <div class="current-status-section">
                <div class="status-grid">
                    <div class="status-item">
                        <i class="fas fa-info-circle"></i> ស្ថានការ​បច្ចុប្បន្ន:
                        <strong id="statusText" class="status-text">Ready</strong>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-hashtag"></i> លេខបច្ចុប្បន្ន:
                        <strong id="currentNumber" class="current-number">-</strong>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="keyboard-hint">
            <i class="fas fa-keyboard"></i> សញ្ញាសម្គាល់ជំនួយ:
            <span class="key">R</span> = Red,
            <span class="key">B</span> = Blue,
            <span class="key">T</span> = Tie,
            <span class="key">E</span> = ចប់សូ,
            <span class="key">U</span> = Undo
        </div>
        <p class="copyright">© 2025 by Puthiroth</p>
    </footer>
</div>

<script>
    // State Management
    let lastWasTie = true;
    let currentCount = 0;
    let consecutiveTieCount = 0;
    let tieShowedZero = false;
    const history = [];

    let currentColor = null;
    let colorSequenceCount = 0;
    let tieSequenceCount = 0;
    let endSessionCount = 0; // Counter for end-session entries

    // DOM Elements
    const logEl = document.getElementById('log');
    const statusText = document.getElementById('statusText');
    const currentNumber = document.getElementById('currentNumber');
    const titleInput = document.getElementById('titleInput');
    const undoBtn = document.getElementById('undo');
    const endSessionBtn = document.getElementById('endSession');

    // Initialize
    function init() {
        // Load title from localStorage
        const savedTitle = localStorage.getItem('clickCounter_title');
        if (savedTitle) {
            titleInput.value = savedTitle;
        }

        // Load data from localStorage if available
        const savedData = localStorage.getItem('clickCounter_data');
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                history.push(...data.history || []);
                currentCount = data.currentCount || 0;
                lastWasTie = data.lastWasTie !== undefined ? data.lastWasTie : true;
                consecutiveTieCount = data.consecutiveTieCount || 0;
                tieShowedZero = data.tieShowedZero || false;
                currentColor = data.currentColor || null;
                colorSequenceCount = data.colorSequenceCount || 0;
                tieSequenceCount = data.tieSequenceCount || 0;
                endSessionCount = data.endSessionCount || 0;

                // Rebuild log
                rebuildLogFromHistory();
            } catch (e) {
                console.error('Error loading saved data:', e);
            }
        }

        refreshUndoButton();
    }

    // Save to localStorage
    function saveToStorage() {
        const data = {
            history: history,
            currentCount: currentCount,
            lastWasTie: lastWasTie,
            consecutiveTieCount: consecutiveTieCount,
            tieShowedZero: tieShowedZero,
            currentColor: currentColor,
            colorSequenceCount: colorSequenceCount,
            tieSequenceCount: tieSequenceCount,
            endSessionCount: endSessionCount
        };
        localStorage.setItem('clickCounter_data', JSON.stringify(data));
    }

    // Save title when user types
    titleInput.addEventListener('input', function() {
        localStorage.setItem('clickCounter_title', this.value);
    });

    function refreshUndoButton() {
        undoBtn.disabled = history.length === 0;
        undoBtn.style.opacity = history.length === 0 ? 0.6 : 1;
    }

    function recordAction(action) {
        history.push(action);
        refreshUndoButton();
        saveToStorage();
    }

    function addEntry(type, number, sequenceNum) {
        const id = 'e_' + Date.now() + Math.random().toString(36).slice(2, 6);
        const row = document.createElement('div');

        // Set class based on type
        if (type === 'end-session') {
            row.className = 'entry end-session';
        } else {
            row.className = `entry ${type}`;
        }

        row.id = id;

        // Create container with grid layout
        const container = document.createElement('div');
        container.className = 'entry-container';

        // Sequence number (LEFT SIDE)
        const sequenceNumDisplay = document.createElement('span');
        sequenceNumDisplay.className = 'sequence-number';
        sequenceNumDisplay.textContent = sequenceNum;

        // Middle section: Badge + Number
        const middleSection = document.createElement('div');
        middleSection.className = 'middle-section';

        const badge = document.createElement('span');
        if (type === 'end-session') {
            badge.className = 'badge end-session';
            badge.textContent = 'ចប់សូ';
        } else if (type === 'tie') {
            badge.className = 'badge tie';
            badge.textContent = 'Tie';
        } else if (type === 'red') {
            badge.className = 'badge red';
            badge.textContent = 'ក្រហម (Red)';
        } else {
            badge.className = 'badge blue';
            badge.textContent = 'ខៀវ (Blue)';
        }

        const numberDisplay = document.createElement('span');
        numberDisplay.className = 'num-display';

        if (type === 'end-session') {
            numberDisplay.textContent = '✓';
        } else {
            numberDisplay.textContent = number === null ? '-' : number;
        }

        middleSection.appendChild(badge);
        middleSection.appendChild(numberDisplay);

        // Right section: Time
        const rightSection = document.createElement('div');
        rightSection.className = 'right-section';

        const time = new Date().toLocaleTimeString('km-KH', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });

        const timeDisplay = document.createElement('span');
        timeDisplay.className = 'time-display';
        timeDisplay.textContent = time;

        rightSection.appendChild(timeDisplay);

        // Assemble the container
        container.appendChild(sequenceNumDisplay);
        container.appendChild(middleSection);
        container.appendChild(rightSection);

        row.appendChild(container);

        // Remove empty message if present
        const emptyMsg = logEl.querySelector('.log-empty');
        if (emptyMsg) {
            emptyMsg.remove();
        }

        logEl.prepend(row);
        return id;
    }

    function pushAndLog(type, number) {
        // Calculate sequence number
        let sequenceNum = 1;

        if (type === 'end-session') {
            endSessionCount++;
            sequenceNum = endSessionCount;
        } else if (type === 'tie') {
            tieSequenceCount++;
            sequenceNum = tieSequenceCount;
        } else {
            if (currentColor !== type) {
                colorSequenceCount = 1;
                currentColor = type;
            } else {
                colorSequenceCount++;
            }
            sequenceNum = colorSequenceCount;
        }

        const action = {
            type,
            number,
            prevCount: currentCount,
            prevLastWasTie: lastWasTie,
            prevConsecutiveTieCount: consecutiveTieCount,
            prevTieShowedZero: tieShowedZero,
            prevColor: currentColor,
            prevColorSequenceCount: colorSequenceCount,
            prevTieSequenceCount: tieSequenceCount,
            prevEndSessionCount: endSessionCount,
            sequenceNumber: sequenceNum
        };

        const entryId = addEntry(type, number, sequenceNum);
        action.entryId = entryId;
        recordAction(action);
    }

    // Red/Blue Button Handler
    function handleRedBlue(type) {
        consecutiveTieCount = 0;
        tieShowedZero = false;

        if (lastWasTie) {
            tieSequenceCount = 0;
            currentCount = 1;
        } else {
            currentCount += 1;
        }

        lastWasTie = false;
        statusText.textContent = 'Last: ' + (type === 'red' ? 'Red' : 'Blue');
        currentNumber.textContent = currentCount;
        pushAndLog(type, currentCount);
    }

    // Tie Button Handler
    document.getElementById('tie').addEventListener('click', () => {
        consecutiveTieCount++;

        let tieNumber;
        let tieStatus = '';

        if (consecutiveTieCount === 1) {
            if (history.length > 0) {
                const lastAction = history[history.length - 1];
                tieNumber = lastAction.number;
                tieStatus = 'តម្លៃមុន = ' + tieNumber;
            } else {
                tieNumber = 1;
                tieStatus = 'តម្លៃមុន = ' + tieNumber;
            }
        } else {
            tieNumber = 0;
            tieShowedZero = true;
            tieStatus = 'តម្លៃ = 0';
        }

        colorSequenceCount = 0;
        currentColor = null;

        pushAndLog('tie', tieNumber);

        lastWasTie = true;
        currentCount = tieNumber;

        statusText.textContent = 'Last: Tie (' + tieStatus + ')';
        currentNumber.textContent = '-';
    });

    // End Session Button Handler
    endSessionBtn.addEventListener('click', () => {
        // Reset counters for end of session
        const sessionEndNumber = currentCount;

        // Add end-session entry
        pushAndLog('end-session', sessionEndNumber);

        // Update status
        statusText.textContent = 'ចប់សូ!';
        currentNumber.textContent = '-';

        // Reset some counters but not all (keep currentCount for next session start)
        // consecutiveTieCount = 0;
        // tieShowedZero = false;
        // lastWasTie = true;
        // currentColor = null;
        // colorSequenceCount = 0;
        // tieSequenceCount = 0;
    });

    // Event Listeners for Red/Blue
    document.getElementById('red').addEventListener('click', () => { handleRedBlue('red'); });
    document.getElementById('blue').addEventListener('click', () => { handleRedBlue('blue'); });

    function showEmptyMessage() {
        logEl.innerHTML = `
            <div class="log-empty">
                <i class="fas fa-inbox"></i> មិនមានការចុចទេ។ ចាប់ផ្តើមចុចព័ណ៌ខាងលើ!
            </div>
        `;
    }

    // Rebuild Log from History
    function rebuildLogFromHistory() {
        logEl.innerHTML = '';

        if (history.length === 0) {
            showEmptyMessage();
            return;
        }

        // Just add entries in reverse order
        for (let i = history.length - 1; i >= 0; i--) {
            const action = history[i];
            addEntry(action.type, action.number, action.sequenceNumber);
        }

        // Update current state from last entry
        const lastAction = history[history.length - 1];
        currentCount = lastAction.number;

        if (lastAction.type === 'end-session') {
            statusText.textContent = 'ចប់សូ!';
            currentNumber.textContent = '-';
            lastWasTie = true;
        } else if (lastAction.type === 'tie') {
            lastWasTie = true;
            currentColor = null;
            colorSequenceCount = 0;
            tieSequenceCount = lastAction.sequenceNumber;

            // Recalculate consecutive ties
            consecutiveTieCount = 0;
            tieShowedZero = false;
            for (let i = history.length - 1; i >= 0; i--) {
                if (history[i].type === 'tie') {
                    consecutiveTieCount++;
                    if (history[i].number === 0) {
                        tieShowedZero = true;
                    }
                } else {
                    break;
                }
            }

            if (tieShowedZero) {
                statusText.textContent = 'Last: Tie (តម្លៃ = 0)';
            } else if (consecutiveTieCount === 1) {
                statusText.textContent = 'Last: Tie (តម្លៃមុន = ' + currentCount + ')';
            } else {
                statusText.textContent = 'Last: Tie (តម្លៃ = 0)';
            }
            currentNumber.textContent = '-';
        } else {
            lastWasTie = false;
            currentColor = lastAction.type;
            colorSequenceCount = lastAction.sequenceNumber;
            tieSequenceCount = 0;
            consecutiveTieCount = 0;
            tieShowedZero = false;

            statusText.textContent = 'Last: ' + (lastAction.type === 'red' ? 'Red' : 'Blue');
            currentNumber.textContent = currentCount;
        }
    }

    // Clear All
    document.getElementById('clear').addEventListener('click', () => {
        if (confirm('តើអ្នកពិតជាចង់សំអាតតារាងទាំងអស់មែនទេ?')) {
            logEl.innerHTML = '';
            history.length = 0;
            currentCount = 0;
            lastWasTie = true;
            consecutiveTieCount = 0;
            tieShowedZero = false;
            currentColor = null;
            colorSequenceCount = 0;
            tieSequenceCount = 0;
            endSessionCount = 0;
            statusText.textContent = 'Ready';
            currentNumber.textContent = '-';
            showEmptyMessage();
            refreshUndoButton();
            saveToStorage();
        }
    });

    // Export CSV
    document.getElementById('export').addEventListener('click', () => {
        const rows = [['លេខរៀង', 'ប្រភេទ', 'លេខ', 'ពេលវេលា', 'ចំណងជើង/កំណត់ចំណាំ']];

        const children = Array.from(logEl.children).reverse();
        children.forEach(ch => {
            if (ch.classList.contains('log-empty')) return;

            const seqNum = ch.querySelector('.sequence-number') ? ch.querySelector('.sequence-number').textContent : '';
            const badge = ch.querySelector('.badge');
            const type = badge ? badge.textContent : '';
            const numberDisplay = ch.querySelector('.num-display');
            const number = numberDisplay ? numberDisplay.textContent : '';
            const time = ch.querySelector('.time-display') ? ch.querySelector('.time-display').textContent : '';
            rows.push([seqNum, type, number, time, titleInput.value]);
        });

        if (children.length === 0 && titleInput.value.trim() !== '') {
            rows.push(['', '', '', '', titleInput.value]);
        }

        const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'click-counter-' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // Undo
    undoBtn.addEventListener('click', () => {
        if (history.length === 0) return;

        // Remove the last action from history
        const last = history.pop();

        // Remove the DOM element
        const el = document.getElementById(last.entryId);
        if (el) el.remove();

        // Update state based on new last entry (if any)
        if (history.length > 0) {
            const newLast = history[history.length - 1];
            currentCount = newLast.number;

            if (newLast.type === 'end-session') {
                endSessionCount = newLast.sequenceNumber;
                statusText.textContent = 'ចប់សូ!';
                currentNumber.textContent = '-';
                lastWasTie = true;
            } else if (newLast.type === 'tie') {
                lastWasTie = true;
                tieSequenceCount = newLast.sequenceNumber;
                colorSequenceCount = 0;
                currentColor = null;

                // Recalculate consecutive ties
                consecutiveTieCount = 0;
                tieShowedZero = false;
                for (let i = history.length - 1; i >= 0; i--) {
                    if (history[i].type === 'tie') {
                        consecutiveTieCount++;
                        if (history[i].number === 0) {
                            tieShowedZero = true;
                        }
                    } else {
                        break;
                    }
                }

                // Update UI for tie
                if (tieShowedZero) {
                    statusText.textContent = 'Last: Tie (តម្លៃ = 0)';
                } else if (consecutiveTieCount === 1) {
                    statusText.textContent = 'Last: Tie (តម្លៃមុន = ' + currentCount + ')';
                } else {
                    statusText.textContent = 'Last: Tie (តម្លៃ = 0)';
                }
                currentNumber.textContent = '-';
            } else {
                // Red/Blue
                lastWasTie = false;
                colorSequenceCount = newLast.sequenceNumber;
                tieSequenceCount = 0;
                currentColor = newLast.type;
                consecutiveTieCount = 0;
                tieShowedZero = false;

                statusText.textContent = 'Last: ' + (newLast.type === 'red' ? 'Red' : 'Blue');
                currentNumber.textContent = currentCount;
            }
        } else {
            // No entries left
            currentCount = 0;
            lastWasTie = true;
            consecutiveTieCount = 0;
            tieShowedZero = false;
            currentColor = null;
            colorSequenceCount = 0;
            tieSequenceCount = 0;
            endSessionCount = 0;
            statusText.textContent = 'Ready';
            currentNumber.textContent = '-';
            showEmptyMessage();
        }

        refreshUndoButton();
        saveToStorage();
    });

    // Keyboard Shortcuts
    document.addEventListener('keydown', (ev) => {
        const key = ev.key.toLowerCase();
        if (document.activeElement === titleInput) return;

        if (key === 'r') {
            ev.preventDefault();
            document.getElementById('red').click();
            document.getElementById('red').classList.add('active');
            setTimeout(() => document.getElementById('red').classList.remove('active'), 200);
        }
        if (key === 'b') {
            ev.preventDefault();
            document.getElementById('blue').click();
            document.getElementById('blue').classList.add('active');
            setTimeout(() => document.getElementById('blue').classList.remove('active'), 200);
        }
        if (key === 't') {
            ev.preventDefault();
            document.getElementById('tie').click();
            document.getElementById('tie').classList.add('active');
            setTimeout(() => document.getElementById('tie').classList.remove('active'), 200);
        }
        if (key === 'e') {
            ev.preventDefault();
            document.getElementById('endSession').click();
            document.getElementById('endSession').classList.add('active');
            setTimeout(() => document.getElementById('endSession').classList.remove('active'), 200);
        }
        if (key === 'u' && !undoBtn.disabled) {
            ev.preventDefault();
            document.getElementById('undo').click();
            document.getElementById('undo').classList.add('active');
            setTimeout(() => document.getElementById('undo').classList.remove('active'), 200);
        }
    });

    // Initialize the application
    init();
</script>
</body>
</html>